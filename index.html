<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Connections Tracker</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #ec4899;
            --bg-grad-start: #1e1b4b;
            --bg-grad-end: #312e81;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --danger: #ef4444;
            --font-stack: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-stack);
            background-color: #f3f4f6;
            color: var(--text-main);
            min-height: 100vh;
        }

        #landing-page {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, var(--bg-grad-start), var(--bg-grad-end));
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; color: white; text-align: center; padding: 1rem;
        }

        .landing-logo { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; letter-spacing: -1px; }
        .landing-sub { color: #a5b4fc; margin-bottom: 3rem; font-size: 1.1rem; }

        .player-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; width: 100%; max-width: 500px; }
        .player-btn {
            background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 2rem 1rem; border-radius: 16px; color: white; font-size: 1.25rem; font-weight: 700;
            cursor: pointer; transition: all 0.2s ease;
        }
        .player-btn:hover { background: white; color: var(--bg-grad-start); transform: translateY(-5px); }

        #main-app { display: none; }

        header {
            background: linear-gradient(135deg, var(--bg-grad-start), var(--bg-grad-end));
            color: white; padding: 1.5rem 1rem; text-align: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 2rem;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 0 1rem 4rem 1rem; display: flex; flex-direction: column; gap: 1.5rem; }
        .grid-row { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }

        @media (min-width: 1024px) {
            .top-grid { grid-template-columns: 1.2fr 1fr 0.8fr; align-items: stretch; }
            .mid-grid { grid-template-columns: 1fr 1fr; }
        }

        .card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); padding: 1.5rem; border: 1px solid var(--border); height: 100%; }
        .card-header { margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 1.125rem; font-weight: 600; }
        
        .form-group { margin-bottom: 1.25rem; }
        label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
        
        .active-player-tag { background: #eef2ff; color: var(--primary); padding: 0.5rem; border-radius: 6px; font-weight: 700; display: inline-block; width: 100%; text-align: center; border: 1px solid #c7d2fe; }

        input[type="date"] { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; }

        .group-selector { display: flex; gap: 0.5rem; }
        .group-btn { flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; background: #fff; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .group-btn.active { background-color: var(--primary); color: white; border-color: var(--primary); }

        .checkbox-wrapper { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; padding: 0.5rem; }
        
        .btn-save { width: 100%; background-color: var(--primary); color: white; padding: 0.75rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-save:disabled { background-color: #9ca3af; cursor: not-allowed; }

        .table-container { max-height: 380px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        th { text-align: left; padding: 0.75rem 0.5rem; color: var(--text-muted); border-bottom: 1px solid var(--border); position: sticky; top: 0; background: white; }
        td { padding: 0.75rem 0.5rem; border-bottom: 1px solid #f3f4f6; }
        
        .score-badge { padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
        .score-3 { background-color: #f3e8ff; color: #6b21a8; }
        .score-2 { background-color: #d1fae5; color: #065f46; }
        .score-1 { background-color: #f3f4f6; color: #374151; }
        .score-0 { background-color: #fee2e2; color: #991b1b; }

        .chart-row { display: flex; align-items: center; margin-bottom: 0.75rem; gap: 1rem; }
        .chart-label { width: 60px; font-weight: 600; font-size: 0.9rem; text-align: right; }
        .chart-track { flex-grow: 1; background-color: #f3f4f6; height: 24px; border-radius: 4px; overflow: hidden; }
        .chart-bar { height: 100%; background: linear-gradient(90deg, var(--secondary), var(--primary)); border-radius: 4px; transition: width 0.5s ease-out; }
        .chart-bar.total-bar { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .chart-value { width: 40px; font-weight: 700; font-size: 0.9rem; }

        .super-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
        .super-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1.25rem; text-align: center; }
        .super-card h4 { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }
        .super-winner { font-size: 1rem; font-weight: 700; color: var(--primary); margin-bottom: 0.25rem;}
        .super-val { font-size: 0.8rem; font-weight: 600; }
        
        .logout-btn { font-size: 0.75rem; color: #a5b4fc; cursor: pointer; text-decoration: underline; background: none; border: none; margin-top: 0.5rem; }
        .month-toggle { padding: 0.25rem 0.5rem; border-radius: 6px; border: 1px solid var(--border); font-size: 0.875rem; color: var(--primary); }
    </style>
</head>
<body>

    <div id="landing-page">
        <div class="landing-logo">Sports Connections</div>
        <p class="landing-sub">Select your name to enter</p>
        <div class="player-grid">
            <button class="player-btn" onclick="enterApp('Al')">Al</button>
            <button class="player-btn" onclick="enterApp('Andres')">Andres</button>
            <button class="player-btn" onclick="enterApp('Mark')">Mark</button>
            <button class="player-btn" onclick="enterApp('Gus')">Gus</button>
        </div>
    </div>

    <div id="main-app">
        <header>
            <h1>Sports Connections Tracker</h1>
            <button class="logout-btn" onclick="location.reload()">‚Üê Switch Player</button>
        </header>
        <div class="container">
            <div class="grid-row top-grid">
                <div class="card">
                    <div class="card-header"><h2 class="card-title">Log Daily Puzzle</h2></div>
                    <div class="form-group"><label>Logging for:</label><div id="activePlayerTag" class="active-player-tag">...</div></div>
                    <div class="form-group"><label>Date</label><input type="date" id="dateEntry"></div>
                    <div class="form-group">
                        <label>Groups Correct</label>
                        <div class="group-selector" id="groupBtnContainer">
                            <button type="button" class="group-btn" data-val="0">0</button>
                            <button type="button" class="group-btn" data-val="1">1</button>
                            <button type="button" class="group-btn" data-val="2">2</button>
                            <button type="button" class="group-btn" data-val="3">3</button>
                            <button type="button" class="group-btn" data-val="4">4</button>
                        </div>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="isPerfect"><label for="isPerfect" style="margin:0; cursor:pointer;">Perfect (No mistakes)</label>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="isPurpleFirst"><label for="isPurpleFirst" style="margin:0; cursor:pointer;">Purple Solved First</label>
                    </div>
                    <button class="btn-save" id="saveBtn" onclick="saveData()">Save Result</button>
                </div>

                <div class="card">
                    <div class="card-header"><h2 class="card-title"><span id="statsPlayerName">...</span>'s History</h2></div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Date</th><th>Right</th><th>Details</th><th style="text-align: right;">Pts</th></tr></thead>
                            <tbody id="historyBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h2 class="card-title">Point Rules</h2></div>
                    <div style="padding-top: 0.5rem;">
                        <h3 style="font-size: 0.75rem; color: #4f46e5; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 0.75rem; border-bottom: 1px solid #f3f4f6; padding-bottom: 0.25rem;">Daily Points</h3>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.9rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between;"><span>Purple 1st</span><span style="color: var(--text-muted)">3 pts</span></div>
                            <div style="display: flex; justify-content: space-between;"><span style="background: #e5e7eb; padding: 0 4px; border-radius: 2px;">Perfect 4</span><span style="color: var(--text-muted)">2 pts</span></div>
                            <div style="display: flex; justify-content: space-between;"><span>4 Groups</span><span style="color: var(--text-muted)">1 pt</span></div>
                            <div style="display: flex; justify-content: space-between;"><span>< 4 Groups</span><span style="color: var(--text-muted)">0 pts</span></div>
                        </div>
                        <h3 style="font-size: 0.75rem; color: #4f46e5; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 0.75rem; border-bottom: 1px solid #f3f4f6; padding-bottom: 0.25rem;">Monthly to Total</h3>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.9rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between;"><strong>1st Place</strong><span style="color: var(--text-muted)">12 pts</span></div>
                            <div style="display: flex; justify-content: space-between;"><strong>2nd Place</strong><span style="color: var(--text-muted)">5 pts</span></div>
                            <div style="display: flex; justify-content: space-between;"><strong>3rd Place</strong><span style="color: var(--text-muted)">3 pts</span></div>
                            <div style="display: flex; justify-content: space-between;"><strong>4th Place</strong><span style="color: var(--text-muted)">1 pt</span></div>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--text-muted); font-style: italic;">*Tied players split points.</p>
                    </div>
                </div>
            </div>

            <div class="grid-row mid-grid">
                <div class="card">
                    <div class="card-header"><h2 class="card-title">Monthly Chart</h2><select id="monthToggle" class="month-toggle" onchange="renderGlobalDashboard()"></select></div>
                    <div id="chartContainer" style="padding: 1rem 0;"></div>
                </div>
                <div class="card">
                    <div class="card-header"><h2 class="card-title">Season Standing</h2></div>
                    <div id="totalPointsContainer" style="padding: 1rem 0;"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2 class="card-title" id="superTitle">Superlatives</h2></div>
                <div class="super-grid" id="superlativesContainer"></div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_2n9zHZ6NEayP0tyu204hoTs9pGt0c_NVXEh0_N83J5xeelc6hV8-vVKX03hIhqav_A/exec"; 

        const PLAYERS = ['Al', 'Andres', 'Mark', 'Gus'];
        let db = {};
        let activePlayer = '';
        let selectedGroups = null;

        const JAN_DATA = [
            { day: 1, Al: 1, Andres: 0, Gus: 0, Mark: 0 }, { day: 2, Al: 0, Andres: 0, Gus: 0, Mark: 1 },
            { day: 3, Al: 1, Andres: 1, Gus: 1, Mark: 1 }, { day: 4, Al: 1, Andres: 0, Gus: 0, Mark: 1 },
            { day: 5, Al: 1, Andres: 0, Gus: 0, Mark: 1 }, { day: 6, Al: 0, Andres: 0, Gus: 0, Mark: 0 },
            { day: 7, Al: 0, Andres: 0, Gus: 3, Mark: 3 }, { day: 8, Al: 3, Andres: 3, Gus: 0, Mark: 1 },
            { day: 9, Al: 1, Andres: 1, Gus: 1, Mark: 0 }, { day: 10, Al: 1, Andres: 1, Gus: 1, Mark: 1 },
            { day: 11, Al: 1, Andres: 1, Gus: 0, Mark: 1 }, { day: 12, Al: 0, Andres: 0, Gus: 0, Mark: 0 },
            { day: 13, Al: 1, Andres: 1, Gus: 0, Mark: 1 }, { day: 14, Al: 0, Andres: 1, Gus: 0, Mark: 1 },
            { day: 15, Al: 1, Andres: 0, Gus: 1, Mark: 1 }, { day: 16, Al: 3, Andres: 3, Gus: 1, Mark: 1 },
            { day: 17, Al: 0, Andres: 0, Gus: 0, Mark: 0 }, { day: 18, Al: 3, Andres: 3, Gus: 1, Mark: 1 },
            { day: 19, Al: 0, Andres: 1, Gus: 0, Mark: 0 }, { day: 20, Al: 3, Andres: 1, Gus: 1, Mark: 1 },
            { day: 21, Al: 0, Andres: 0, Gus: 0, Mark: 1 }, { day: 22, Al: 0, Andres: 0, Gus: 0, Mark: 1 },
            { day: 23, Al: 3, Andres: 1, Gus: 1, Mark: 1 }, { day: 24, Al: 0, Andres: 1, Gus: 1, Mark: 1 },
            { day: 25, Al: 0, Andres: 1, Gus: 1, Mark: 1 }, { day: 26, Al: 1, Andres: 1, Gus: 0, Mark: 0 },
            { day: 27, Al: 3, Andres: 3, Gus: 3, Mark: 0 }, { day: 28, Al: 0, Andres: 0, Gus: 0, Mark: 3 },
            { day: 29, Al: 0, Andres: 3, Gus: 0, Mark: 0 }, { day: 30, Al: 0, Andres: 1, Gus: 0, Mark: 1 },
            { day: 31, Al: 1, Andres: 0, Gus: 1, Mark: 0 }
        ];

        async function init() {
            PLAYERS.forEach(p => db[p] = []);
            loadJanuaryData(); 
            document.getElementById('dateEntry').valueAsDate = new Date();
            setupInteractionListeners();
            try { await refreshDataFromCloud(); } catch (e) { console.warn("Cloud pull failed"); }
            populateMonthToggle();
            renderGlobalDashboard();
        }

        function loadJanuaryData() {
            JAN_DATA.forEach(row => {
                const d = `2025-01-${String(row.day).padStart(2, '0')}`;
                PLAYERS.forEach(p => {
                    const s = row[p];
                    db[p].push({ date: d, score: s, groups: s > 0 ? 4 : 0, perfect: s >= 2, purple: s === 3 });
                });
            });
        }

		async function refreshDataFromCloud() {
			if (!SCRIPT_URL || SCRIPT_URL.includes("https://script.google.com/macros/s/AKfycbz_2n9zHZ6NEayP0tyu204hoTs9pGt0c_NVXEh0_N83J5xeelc6hV8-vVKX03hIhqav_A/exec")) return;
			
			try {
				// IMPORTANT: No 'no-cors' here. Google supports CORS for GET.
				const response = await fetch(SCRIPT_URL); 
				
				if (!response.ok) throw new Error('Network response was not ok');
				
				const cloudData = await response.json();
				console.log("Syncing from cloud...", cloudData.length, "rows found.");

				// Clear existing February entries before rebuilding from sheet
				PLAYERS.forEach(p => {
					db[p] = db[p].filter(e => e.date.startsWith("2025-01"));
				});

				cloudData.forEach(row => {
					const [date, player, groups, perfect, purple, score] = row;
					if(db[player]) {
						db[player].push({ 
							date: date, 
							groups: parseInt(groups), 
							perfect: String(perfect) === "true", 
							purple: String(purple) === "true", 
							score: parseInt(score) 
						});
					}
				});

				renderGlobalDashboard();
				if(activePlayer) renderHistory(activePlayer);

			} catch (e) {
				console.error("Critical Sync Error:", e);
			}
		}

        function setupInteractionListeners() {
            document.querySelectorAll('.group-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.group-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedGroups = parseInt(btn.dataset.val);
                };
            });
        }

		async function enterApp(name) {
			activePlayer = name;
			document.getElementById('landing-page').style.display = 'none';
			document.getElementById('main-app').style.display = 'block';
			document.getElementById('activePlayerTag').innerText = name;
			document.getElementById('statsPlayerName').innerText = name;
			
			// This forces the app to look at the cloud the moment you click a name
			await refreshDataFromCloud(); 
			
			renderHistory(name);
			renderGlobalDashboard();
		}

        async function saveData() {
            const d = document.getElementById('dateEntry').value;
            if (!d || selectedGroups === null) return alert("Select date and groups!");
            
            const perf = document.getElementById('isPerfect').checked;
            const purp = document.getElementById('isPurpleFirst').checked;
            const s = selectedGroups < 4 ? 0 : (purp ? 3 : (perf ? 2 : 1));

            const payload = { date: d, player: activePlayer, groups: selectedGroups, perfect: perf, purple: purp, score: s };
            const btn = document.getElementById('saveBtn');
            btn.disabled = true; 
            btn.innerText = "Syncing...";

            // 1. UPDATE LOCAL HISTORY IMMEDIATELY
            db[activePlayer] = db[activePlayer].filter(entry => entry.date !== d);
            db[activePlayer].push({ date: d, groups: selectedGroups, perfect: perf, purple: purp, score: s });
            
            renderHistory(activePlayer);
            populateMonthToggle();
            renderGlobalDashboard();

            try {
                await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify(payload) 
                });
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerText = "Save Result";
                    refreshDataFromCloud(); 
                }, 1000);
            } catch (e) { 
                btn.disabled = false;
                btn.innerText = "Save Result";
            }
        }

        function populateMonthToggle() {
            const select = document.getElementById('monthToggle');
            const rawMonths = Object.values(db).flat().map(e => e.date.slice(0, 7));
            const currentMonth = new Date().toISOString().slice(0, 7);
            rawMonths.push(currentMonth);
            const months = [...new Set(rawMonths)].sort().reverse();
            const savedSelection = select.value;
            select.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('');
            select.value = savedSelection || currentMonth;
        }

        function renderHistory(p) {
            const hist = [...db[p]].sort((a,b) => b.date.localeCompare(a.date));
            document.getElementById('historyBody').innerHTML = hist.map(e => `
                <tr><td>${e.date.slice(5)}</td><td>${e.groups}/4</td><td>${e.purple?'Purp':(e.perfect?'Perf':'-')}</td>
                <td style="text-align:right"><span class="score-badge score-${e.score}">+${e.score}</span></td></tr>
            `).join('');
        }

        function renderGlobalDashboard() {
            const month = document.getElementById('monthToggle').value;
            if(!month) return;
            
            const monthlyScores = PLAYERS.map(p => ({ 
                name: p, pts: db[p].filter(e => e.date.startsWith(month)).reduce((a,b) => a+b.score, 0) 
            }));
            const maxM = Math.max(...monthlyScores.map(d => d.pts), 1);
            document.getElementById('chartContainer').innerHTML = monthlyScores.sort((a,b) => b.pts - a.pts).map(d => `
                <div class="chart-row"><div class="chart-label">${d.name}</div>
                <div class="chart-track"><div class="chart-bar" style="width:${(d.pts/maxM)*100}%"></div></div>
                <div class="chart-value">${d.pts}</div></div>`).join('');

            const allMonths = [...new Set(Object.values(db).flat().map(e => e.date.slice(0, 7)))].sort();
            let seasonBonusTotals = { 'Al': 0, 'Andres': 0, 'Mark': 0, 'Gus': 0 };
            const today = new Date().toISOString().slice(0, 7);

            allMonths.forEach(m => {
                if (m < today) {
                    const mRank = PLAYERS.map(p => ({
                        name: p, pts: db[p].filter(e => e.date.startsWith(m)).reduce((a,b) => a+b.score, 0)
                    })).sort((a,b) => b.pts - a.pts);
                    const bonuses = [12, 5, 3, 1];
                    mRank.forEach((player, index) => { seasonBonusTotals[player.name] += bonuses[index]; });
                }
            });

            const seasonData = PLAYERS.map(p => ({ name: p, pts: seasonBonusTotals[p] }));
            const maxS = Math.max(...seasonData.map(d => d.pts), 1);
            document.getElementById('totalPointsContainer').innerHTML = seasonData.sort((a,b) => b.pts - a.pts).map(d => `
                <div class="chart-row"><div class="chart-label">${d.name}</div>
                <div class="chart-track"><div class="chart-bar total-bar" style="width:${(d.pts/maxS)*100}%"></div></div>
                <div class="chart-value">${d.pts}</div></div>`).join('');

            renderSuperlatives(month);
        }

        function renderSuperlatives(month) {
            const configs = [
                { l: 'Most 3 Pts', k: '3pt' }, { l: 'Most 1 Pt', k: '1pt' }, { l: 'Most 0 Pts', k: '0pt' },
                { l: 'Longest Streak', k: 'str' }, { l: 'Dry Spell', k: 'dry' }
            ];
            document.getElementById('superlativesContainer').innerHTML = configs.map(s => {
                const res = PLAYERS.map(p => {
                    const mHist = db[p].filter(e => e.date.startsWith(month)).sort((a,b) => a.date.localeCompare(b.date));
                    let val = 0;
                    if(s.k === '3pt') val = mHist.filter(e => e.score === 3).length;
                    if(s.k === '1pt') val = mHist.filter(e => e.score === 1).length;
                    if(s.k === '0pt') val = mHist.filter(e => e.score === 0).length;
                    if(s.k === 'str') { let c=0,m=0; mHist.forEach(e=>{if(e.score>0){c++;m=Math.max(m,c);}else c=0;}); val=m; }
                    if(s.k === 'dry') { let c=0,m=0; mHist.forEach(e=>{if(e.score===0){c++;m=Math.max(m,c);}else c=0;}); val=m; }
                    return { n: p, v: val };
                });
                const topVal = Math.max(...res.map(r => r.v));
                const winners = res.filter(r => r.v === topVal && topVal > 0).map(r => r.n);
                return `<div class="super-card"><h4>${s.l}</h4><div class="super-winner">${winners.length?winners.join(', '):'N/A'}</div><div class="super-val">${topVal}</div></div>`;
            }).join('');
        }
        init();
    </script>
</body>
</html>
